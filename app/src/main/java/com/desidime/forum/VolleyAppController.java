package com.desidime.forum;

import android.app.Application;
import android.content.Context;
import android.graphics.Bitmap;
import android.support.v4.util.LruCache;
import android.util.Log;

import com.android.volley.RequestQueue;
import com.android.volley.toolbox.ImageLoader;
import com.android.volley.toolbox.Volley;

import java.security.SecureRandom;
import java.security.cert.CertificateException;
import java.security.cert.X509Certificate;

import javax.net.ssl.HostnameVerifier;
import javax.net.ssl.HttpsURLConnection;
import javax.net.ssl.SSLContext;
import javax.net.ssl.SSLSession;
import javax.net.ssl.TrustManager;
import javax.net.ssl.X509TrustManager;

/**
 * Class for handling all network requests
 */
public class VolleyAppController extends Application {
  private static VolleyAppController instance;
  private RequestQueue requestQueue;
  private ImageLoader imageLoader;


  private VolleyAppController(Context context) {
    try {
      /* Trusting all the certificates */
      TrustManager[] trustAllCerts = new TrustManager[] {
          new X509TrustManager() {
            @Override
            public void checkClientTrusted(X509Certificate[] chain, String authType) throws CertificateException {
            }

            @Override
            public void checkServerTrusted(X509Certificate[] chain, String authType) throws CertificateException {
            }

            public X509Certificate[] getAcceptedIssuers() {
              X509Certificate[] myTrustedAnchors = new X509Certificate[0];
              return myTrustedAnchors;
            }
          }
      };

      SSLContext sc = SSLContext.getInstance("SSL");
      sc.init(null, trustAllCerts, new SecureRandom());
      HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());
      HttpsURLConnection.setDefaultHostnameVerifier(new HostnameVerifier() {
        @Override
        public boolean verify(String arg0, SSLSession arg1) {
          return true;
        }
      });

    } catch (Exception e) {
      Log.e("Volley TrustManager:",e.toString());
    }

    requestQueue = Volley.newRequestQueue(context);

    imageLoader = new ImageLoader(requestQueue, new ImageLoader.ImageCache() {
      private final LruCache<String, Bitmap> cache = new LruCache<String, Bitmap>(20);


      @Override
      public Bitmap getBitmap(String url) {
        return cache.get(url);
      }

      @Override
      public void putBitmap(String url, Bitmap bitmap) {
        cache.put(url, bitmap);
      }
    });
  }

  public static VolleyAppController getInstance(Context context) {
    if (instance == null) {
      instance = new VolleyAppController(context);
    }
    return instance;
  }

  public RequestQueue getRequestQueue() {
    return requestQueue;
  }

  public ImageLoader getImageLoader() {
    return imageLoader;
  }


}